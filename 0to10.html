<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
    <title>0 to 10</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
        :root {
            --bg-color: #f0f2f5;
            --text-color: #333;
            --border-color: #333;
            --input-bg-color: #ffffff;
            --input-border-color: #aaa;
            --icon-fill-color: #333;
            --modal-bg: rgba(0, 0, 0, 0.4);
            --modal-content-bg: #fff;
            --sidebar-dark-bg: #212529;
            --sidebar-text: #f8f9fa;
        }

        body.dark-mode {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --border-color: #e0e0e0;
            --input-bg-color: #2a2a2a;
            --input-border-color: #555;
            --icon-fill-color: #e0e0e0;
            --modal-bg: rgba(0, 0, 0, 0.7);
            --modal-content-bg: #2a2a2a;
            --sidebar-dark-bg: #212529;
            --sidebar-text: #f8f9fa;
        }
        
        * {
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: row;
            min-height: 100vh;
            margin: 0;
            overflow: hidden; 
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .sidebar {
            width: 70px;
            flex-shrink: 0;
            background-color: var(--sidebar-dark-bg);
            color: var(--sidebar-text);
            padding: 20px 10px;
            display: flex;
            flex-direction: column;
            z-index: 100;
            overflow: hidden; 
        }

        .sidebar-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .sidebar-spacer {
            flex-grow: 1;
        }
        
        .sidebar-group:last-child {
             margin-bottom: 0;
        }

        .sidebar-header {
            font-size: 0.9em;
            font-weight: 600;
            color: #adb5bd;
            text-transform: uppercase;
            border-bottom: 1px solid #495057;
            padding-bottom: 5px;
            white-space: nowrap;
            opacity: 0; 
        }

        .sidebar-item {
            padding: 10px 12px;
            font-size: 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s, justify-content 0.3s ease;
            color: white;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 0;
            background-color: #495057;
            white-space: nowrap;
            overflow: hidden;
            justify-content: center;
        }
        
        .sidebar-item:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background-color: #495057;
        }
        
        .sidebar-item svg {
            width: 18px;
            height: 18px;
            fill: var(--sidebar-text);
            flex-shrink: 0; 
        }

        .sidebar-item span {
            display: none;
        }

        .sidebar-item:not(:disabled):hover {
            background-color: #5a6268;
        }
        
        .sidebar-item:active {
            transform: scale(0.98);
        }

        #addButton { background-color: #2ecc71; }
        #addButton:hover { background-color: #27ae60; }
        #resetButton { background-color: #e74c3c; }
        #resetButton:hover { background-color: #c0392b; }

        #zoom-slider {
            width: 20px;
            height: 120px;
            cursor: pointer;
            opacity: 1;
            transition: opacity 0.2s ease;
            -webkit-appearance: slider-vertical;
            appearance: slider-vertical;
            
            display: block; 
            margin: 15px auto 0 auto;
        }


        .main-wrapper {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        #scale-title {
            width: 100%;
            border: none;
            background: none;
            color: var(--text-color);
            font-size: 2.5em;
            font-weight: bold;
            text-align: center;
            padding: 20px 40px 10px 40px;
            outline: none;
            white-space: nowrap;
            overflow: hidden;
            flex-shrink: 0;
        }
        #scale-title:empty:before {
            content: attr(data-placeholder);
            color: var(--input-border-color);
            font-weight: normal;
        }

        .content-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 0 40px 20px 40px;
            overflow: hidden;
            transition: justify-content 0.4s ease;
        }
        
        .content-area.view-mode-center {
            justify-content: center;
        }

        .scroll-wrapper {
            width: 100%;
            overflow-x: auto;
            padding-bottom: 20px;
        }
        
        .scale-panning-container {
            width: 100%;
            position: relative;
            transition: width 0.1s linear, padding 0.4s ease;
            padding-top: 80vh;
            padding-bottom: 0;
        }
        
        .content-area.view-mode-center .scale-panning-container {
        }

        .scale-bar {
            width: 100%;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: linear-gradient(to right, #e74c3c, #f1c40f, #2ecc71);
            transition: border-color 0.3s ease, top 0.4s ease, bottom 0.4s ease, transform 0.4s ease;
            position: absolute;
            bottom: 0;
            left: 0;
            transform: translateY(0);
        }
        
        .content-area.view-mode-center .scale-bar {
            top: 50%;
            bottom: auto;
            transform: translateY(-50%);
        }
        
        .division-container {
            position: absolute;
            width: 120px;
            display: flex;
            align-items: center;
            transform: translateX(-50%);
            transition: left 0.3s ease, opacity 0.2s ease, top 0.4s ease, bottom 0.4s ease;
            pointer-events: none; 
        }
        
        .division-container.position-up {
            bottom: 10px;
            flex-direction: column;
        }
        
        .division-container.position-down {
            top: 10px;
            bottom: auto;
            flex-direction: column-reverse;
        }

        .division-container.dragging {
            opacity: 0.5;
            cursor: grabbing;
            transition: none;
            z-index: 1000;
        }
        
        .division-btn-controls {
            position: absolute; 
            top: -15px; 
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            display: flex;
            gap: 8px;
            height: 24px;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none; 
        }
        
        .position-down .division-btn-controls {
            top: auto;
            bottom: -15px;
        }
        
        .division-container input[type="text"]:hover + .division-btn-controls,
        .division-container input[type="text"]:focus + .division-btn-controls,
        .division-btn-controls:hover { 
            opacity: 1;
            pointer-events: auto; 
        }

        .division-btn-controls button {
            width: 24px;
            height: 24px;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            pointer-events: auto; 
        }
        
        #add-image-btn { 
            background-color: #007bff;
        }
        
        #add-image-btn:hover {
            background-color: #0056b3;
        }
        
        #remove-image-from-div-btn {
            background-color: #7f8c8d;
            display: none;
        }
        
        #remove-image-from-div-btn:hover {
            background-color: #95a5a6;
        }
        
        #remove-division-btn { 
            background-color: #e74c3c;
        }
        
        #remove-division-btn:hover {
            background-color: #c0392b;
        }
        
        .division-container.has-image #add-image-btn {
            display: none;
        }
        
        .division-container.has-image #remove-image-from-div-btn {
            display: flex;
        }

        
        .remove-division-btn {
            background-color: #e74c3c;
        }
        
        .division-stem {
            width: 3px;
            background-color: var(--border-color);
            transition: background-color 0.3s ease, height 0.3s ease;
            pointer-events: none; 
        }
        
        .division-container input[type="text"] {
            width: 100%;
            padding: 5px;
            background-color: var(--input-bg-color);
            color: var(--text-color);
            border: 1px solid var(--input-border-color);
            border-radius: 5px;
            text-align: center;
            box-sizing: border-box;
            font-size: 14px;
            margin-top: 5px;
            margin-bottom: 5px;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
            position: relative;
            z-index: 2;
            order: 2;
            cursor: grab;
            pointer-events: auto; 
        }
        
        .division-container.dragging input[type="text"] {
            cursor: grabbing;
        }

        .image-container {
            width: 100%;
            margin-bottom: 5px;
            position: relative;
            order: 0;
            pointer-events: none; 
        }
		
        .division-container:hover {
            z-index: 100;
            transition-delay: 0s;
        }
		
        .image-container img {
            width: 100%;
            height: auto;
            border-radius: 5px;
            border: 1px solid var(--input-border-color);
            display: block;
        }
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--modal-bg); display: flex; align-items: center; justify-content: center; z-index: 2000;
        }
        .modal-content {
            background-color: var(--modal-content-bg); padding: 30px; border-radius: 10px; max-width: 600px; width: 90%; position: relative; line-height: 1.6;
        }
        .modal-close {
            position: absolute; top: 15px; right: 15px; font-size: 24px; font-weight: bold; cursor: pointer; color: var(--text-color);
        }
        .modal-content h2 {
            margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;
        }
        
    </style>
</head>
<body>

    <nav class="sidebar">
        
        <div class="sidebar-group">
            <button id="theme-toggle-btn" class="sidebar-item" title="Переключить тему">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22ZM12 20V4C16.4183 4 20 7.58172 20 12C20 16.4183 16.4183 20 12 20Z"/>
                </svg>
            </button>
            <button id="help-btn" class="sidebar-item" title="Помощь">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v2h-2V7zm0 4h2v6h-2v-6z"/>
                </svg>
			</button>
            <button id="undo-btn" class="sidebar-item" title="Отменить" disabled>
                 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C20.08 11.03 16.63 8 12.5 8z"/>
                 </svg>
            </button>
            <button id="redo-btn" class="sidebar-item" title="Вернуть" disabled>
                 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                     <path d="m 11.97,8c 2.65,0 5.05,0.99 6.9,2.6L 22.47,7v 9h -9l 3.62,-3.62C 15.7,11.22 13.93,10.5 11.97,10.5 8.43,10.5 5.42,12.81 4.37,16L 2,15.22C 4.39,11.03 7.84,8 11.97,8 Z"/>
                 </svg>
            </button>
        </div>

        <div class="sidebar-spacer"></div>

        <div class="sidebar-group">
            <div class="sidebar-header"><span>Вид</span></div>
            <button id="viewModeBottomBtn" class="sidebar-item" title="Вид: Снизу">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M22 21H2V17H22V21ZM13 15H11V3H13V15Z"/>
                </svg>
            </button>
            <button id="viewModeCenterBtn" class="sidebar-item" title="Вид: По центру">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M22 11V13H2V11H22ZM13 19H11V5H13V19Z"/>
                </svg>
            </button>
        </div>
        
        <div class="sidebar-group">
            <div class="sidebar-header"></div>
            <button id="addButton" class="sidebar-item" title="Добавить">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                </svg>
            </button>
            <button id="resetButton" class="sidebar-item" title="Сбросить">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                </svg>
            </button>
        </div>
        
        <div class="sidebar-group">
            <div class="sidebar-header"></div>
            <button id="zoom-reset-btn" class="sidebar-item" title="Сбросить приближение">
                 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14zm.5-7H9v2H7v1h2v2h1v-2h2V9h-2V7z"/>
                </svg>
            </button>
            <input type="range" id="zoom-slider" min="1" max="10" step="0.1" value="1">
            <button id="screenshotButton" class="sidebar-item" title="Скриншот">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                </svg>
            </button>
        </div>

    </nav>

    <main class="main-wrapper">
        <div id="scale-title" contenteditable="true" data-placeholder="Введите заголовок..."></div>
        
        <main class="content-area" id="contentArea">
            <div class="scroll-wrapper" id="scrollWrapper">
                <div class="scale-panning-container" id="scalePanningContainer">
                    <div class="scale-bar" id="scaleBar">
                        </div>
                </div>
            </div>
        </main>
    </main>
    
    <div id="help-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <span class="modal-close" id="modalClose">&times;</span>
            <h2>Как пользоваться сайтом</h2>
            <ul>
                <li><b>Заголовок:</b> Кликните на текст "Введите заголовок...", чтобы его изменить.</li>
                <li><b>Добавить:</b> Кнопка "+" на левой панели добавляет новый элемент.</li>
                <li><b>Удалить:</b> Наведите курсор на элемент, появится красный крестик. Нажмите, чтобы удалить элемент.</li>
                <li><b>Перемещение:</b> Нажмите и удерживайте текстовое поле, чтобы перетащить его на новую позицию.</li>
                <li><b>Картинки:</b> Наведите курсор на текстовое поле, и над ним появится синяя кнопка "+". Скопируйте картинку и нажмите на "+", чтобы вставить ее. Чтобы её убрать, нажмите на серую кнопку с минусом.</li>
                <li><b>Отменить/Вернуть:</b> Кнопки со стрелками отменяют или возвращают последнее действие (кроме масштаба/вида).</li>
                <li><b>Вид:</b> Кнопки по центру левой панели меняют компоновку шкалы.</li>
                <li><b>Масштаб:</b> Используйте ползунок "Приближение" на левой панели, чтобы растянуть шкалу.</li>
                <li><b>Скриншот:</b> Кнопка "Камера" делает снимок всей вашей шкалы включая заголовок (снимется вся шкала, даже если она растянута за пределы монитора) и скачивает его.</li>
				<li><b>Сохранение:</b> Все изменения (порядок, текст, изображения, вид, заголовок) сохраняются автоматически.</li>
            </ul>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            const contentArea = document.getElementById('contentArea');
            const scaleBar = document.getElementById('scaleBar');
            const addButton = document.getElementById('addButton');
            const themeToggleButton = document.getElementById('theme-toggle-btn');
            const helpBtn = document.getElementById('help-btn');
            const helpModal = document.getElementById('help-modal');
            const modalClose = document.getElementById('modalClose');
            const zoomSlider = document.getElementById('zoom-slider');
            const scalePanningContainer = document.getElementById('scalePanningContainer');
            const viewModeBottomBtn = document.getElementById('viewModeBottomBtn');
            const viewModeCenterBtn = document.getElementById('viewModeCenterBtn');
            const scaleTitle = document.getElementById('scale-title');
            const resetButton = document.getElementById('resetButton');
            const screenshotButton = document.getElementById('screenshotButton');
			const zoomResetBtn = document.getElementById('zoom-reset-btn'); 
			const undoBtn = document.getElementById('undo-btn');
            const redoBtn = document.getElementById('redo-btn');

            let divisionsData = [];
            let draggedElement = null;
            let draggedId = null;
            let db = null;
            let currentViewMode = 'bottom';
            const MAX_TITLE_FONT_SIZE = 2.5;
            const MIN_TITLE_FONT_SIZE = 0.8;
            const DB_NAME = 'ScaleDB';
            const STORE_NAME = 'divisions';

            let historyStack = [];
            let historyIndex = -1;
            let isRestoringState = false; 

            async function initDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, 1);
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(STORE_NAME)) {
                            db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                        }
                    };
                    request.onsuccess = (event) => {
                        db = event.target.result;
                        resolve(db);
                    };
                    request.onerror = (event) => reject(event.target.errorCode);
                });
            }

            async function loadData() {
                return new Promise((resolve, reject) => {
                    if (!db) return reject("DB not initialized");
                    const transaction = db.transaction([STORE_NAME], 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.getAll();
                    request.onsuccess = () => {
                        const data = request.result.sort((a, b) => a.order - b.order);
                        resolve(data);
                    };
                    request.onerror = (event) => reject(event.target.errorCode);
                });
            }

            async function saveData() {
                if (!db || isRestoringState) return;
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    store.clear().onsuccess = () => {
                        if (divisionsData.length === 0) {
                             resolve();
                             return;
                        }
                        let count = 0;
                        divisionsData.forEach((item, index) => {
                            item.order = index; 
                            const request = store.put(item);
                            request.onsuccess = () => {
                                count++;
                                if (count === divisionsData.length) {
                                    resolve();
                                }
                            };
                            request.onerror = (e) => reject(e.target.errorCode);
                        });
                    };
                });
            }
            
            function getDefaultData() {
                 return [
                    { id: 1, text: "Плохо", image: null, order: 0 },
                    { id: 2, text: "Не очень", image: null, order: 1 },
                    { id: 3, text: "Mid", image: null, order: 2 },
                    { id: 4, text: "Отлично", image: null, order: 3 }
                ];
            }
            
            async function resetDataToDefault() {
                if (confirm("Вы уверены, что хотите сбросить всю шкалу? Это действие необратимо.")) {
                    divisionsData = getDefaultData();
                    captureState();
                    await saveData(); 
                    scaleTitle.innerText = '';
                    localStorage.removeItem('scaleTitle');
                    adjustTitleFontSize();
                    renderDivisions();
                }
            }

            // === ФУНКЦИИ ИСТОРИИ ===
            function updateUndoRedoButtons() {
                undoBtn.disabled = historyIndex <= 0;
                redoBtn.disabled = historyIndex >= historyStack.length - 1;
            }

            function captureState() {
                if (isRestoringState) return; 
                
                try {
                    const newState = divisionsData.map(item => ({...item}));
                    historyStack = historyStack.slice(0, historyIndex + 1); 
                    historyStack.push(newState);
                    historyIndex++;
                    updateUndoRedoButtons();
                } catch (e) {
                    console.error("Ошибка клонирования состояния для истории:", e);
                }
            }

            function undo() {
                if (historyIndex <= 0) return;
                
                isRestoringState = true; 
                historyIndex--;
                 try {
                   divisionsData = historyStack[historyIndex].map(item => ({...item}));
                   renderDivisions();
                   saveData(); 
                } catch (e) {
                   console.error("Ошибка восстановления состояния:", e);
                   historyIndex++; 
                } finally {
                   isRestoringState = false; 
                   updateUndoRedoButtons();
                }
            }
            
            function redo() {
                if (historyIndex >= historyStack.length - 1) return;

                isRestoringState = true; 
                historyIndex++;
                 try {
                    divisionsData = historyStack[historyIndex].map(item => ({...item}));
                   renderDivisions();
                   saveData(); 
                } catch (e) {
                   console.error("Ошибка восстановления состояния:", e);
                   historyIndex--; 
                } finally {
                    isRestoringState = false; 
                    updateUndoRedoButtons();
                }
            }

            undoBtn.addEventListener('click', undo);
            redoBtn.addEventListener('click', redo);


            const applyTheme = (theme) => document.body.classList.toggle('dark-mode', theme === 'dark');
            themeToggleButton.addEventListener('click', () => {
                const newTheme = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
                applyTheme(newTheme);
                localStorage.setItem('theme', newTheme);
            });
            
            helpBtn.addEventListener('click', () => { helpModal.style.display = 'flex'; });
            modalClose.addEventListener('click', () => { helpModal.style.display = 'none'; });
            helpModal.addEventListener('click', (e) => {
                if (e.target === helpModal) {
                    helpModal.style.display = 'none';
                }
            });
            
            function adjustTitleFontSize() {
                const el = scaleTitle;
                let currentFontSize = MAX_TITLE_FONT_SIZE;
                el.style.fontSize = currentFontSize + 'em'; 
                
                if (el.clientWidth === 0) return; 
                
                while (el.scrollWidth > el.clientWidth && currentFontSize > MIN_TITLE_FONT_SIZE) {
                    currentFontSize -= 0.1;
                    el.style.fontSize = currentFontSize + 'em';
                }
            }
            
            scaleTitle.addEventListener('input', () => {
                adjustTitleFontSize();
                localStorage.setItem('scaleTitle', scaleTitle.innerText);
            });
            scaleTitle.addEventListener('change', () => {
                captureState();
            });
            

            zoomSlider.addEventListener('input', (e) => {
                const zoomLevel = e.target.value;
                scalePanningContainer.style.width = `${zoomLevel * 100}%`;
                renderDivisions();
            });

            zoomResetBtn.addEventListener('click', () => {
                zoomSlider.value = "1";
                scalePanningContainer.style.width = `100%`;
                setTimeout(renderDivisions, 0);
            });


            function applyViewMode(mode) {
                currentViewMode = mode;
                contentArea.classList.toggle('view-mode-center', mode === 'center');
                viewModeBottomBtn.disabled = (mode === 'bottom');
                viewModeCenterBtn.disabled = (mode === 'center');
            }

            function setAndSaveViewMode(mode) {
                applyViewMode(mode);
                localStorage.setItem('viewMode', mode);
                renderDivisions();
            }

            viewModeBottomBtn.addEventListener('click', () => setAndSaveViewMode('bottom'));
            viewModeCenterBtn.addEventListener('click', () => setAndSaveViewMode('center'));
            
            function blobToDataURL(blob) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            }

            async function takeScreenshot() {
                 const titleEl = document.getElementById('scale-title');
                const scaleContainerEl = document.getElementById('scalePanningContainer');
                const titleValue = titleEl.innerText.trim();
                
                const captureDiv = document.createElement('div');
                captureDiv.style.position = 'absolute';
                captureDiv.style.left = '-9999px';
                captureDiv.style.width = Math.max(scaleContainerEl.scrollWidth, titleEl.scrollWidth) + 40 + 'px';
                captureDiv.style.padding = '20px';
                captureDiv.style.display = 'flex';
                captureDiv.style.flexDirection = 'column';
                captureDiv.style.alignItems = 'center';
                
                const bgColor = getComputedStyle(document.body).backgroundColor;
                captureDiv.style.background = bgColor;

                if (titleValue !== '') {
                    const titleClone = titleEl.cloneNode(true);
                    titleClone.style.fontSize = scaleTitle.style.fontSize;
                    titleClone.style.width = '100%';
                    titleClone.style.color = getComputedStyle(titleEl).color;
                    titleClone.style.marginBottom = '0px'; 
                    captureDiv.appendChild(titleClone);
                    
                    const titleSpacer = document.createElement('div');
                    titleSpacer.style.height = '10px'; 
                    captureDiv.appendChild(titleSpacer);
                }
                
                const scaleClone = scaleContainerEl.cloneNode(true);
                scaleClone.style.paddingTop = getComputedStyle(scaleContainerEl).paddingTop;
                scaleClone.style.paddingBottom = getComputedStyle(scaleContainerEl).paddingBottom || '0px'; 
                scaleClone.style.width = '100%';
                
                const allInputs = scaleClone.querySelectorAll('input[type="text"]');
                allInputs.forEach(input => {
                    input.style.color = 'transparent';
                    input.style.caretColor = 'transparent'; 
                    input.placeholder = ''; 
                });

                const allImgTags = scaleClone.querySelectorAll('.image-container img');
                const conversionPromises = [];
                
                allImgTags.forEach(imgTag => {
                    const container = imgTag.closest('.division-container');
                    if (container) {
                        const id = Number(container.dataset.id);
                        const item = divisionsData.find(d => d.id === id);
                        if (item && item.image) {
                            conversionPromises.push(
                                blobToDataURL(item.image).then(dataUrl => {
                                    imgTag.src = dataUrl;
                                })
                            );
                        }
                    }
                });

                await Promise.all(conversionPromises);
                
                captureDiv.appendChild(scaleClone);
                document.body.appendChild(captureDiv);

                try {
                    await new Promise(resolve => setTimeout(resolve, 100)); 
                    
                    const canvas = await html2canvas(captureDiv, {
                        useCORS: true,
                        width: captureDiv.scrollWidth, 
                        height: captureDiv.scrollHeight,
                        windowWidth: captureDiv.scrollWidth,
                        windowHeight: captureDiv.scrollHeight,
                        backgroundColor: bgColor
                    });
                    
                    const a = document.createElement('a');
                    a.href = canvas.toDataURL('image/png');
                    a.download = (titleValue || 'scale') + '.png';
                    a.click();
                    
                } catch (err) {
                    console.error('Ошибка скриншота:', err);
                    alert('Не удалось сделать скриншот.');
                } finally {
                    document.body.removeChild(captureDiv);
                }
            }
            
            screenshotButton.addEventListener('click', takeScreenshot);
            resetButton.addEventListener('click', resetDataToDefault);

            function getDivisionStyles(index, layoutParams) {
                const { isOverlapping, maxLevels } = layoutParams;
                let level = 0;
                let positionClass = '';

                if (currentViewMode === 'center') {
                    const isUp = (index + 1) % 2 !== 0;
                    positionClass = isUp ? 'position-up' : 'position-down';
                    const typeIndex = Math.floor(index / 2); 
                    level = typeIndex % maxLevels;
                } else { 
                    positionClass = 'position-up';
                    level = index % maxLevels;
                }

                const baseStemHeight = 40;
                const rowHeight = 60;
                const stemHeight = baseStemHeight + (level * rowHeight);
                return { stemHeight, positionClass, level };
            }

            function getLayoutParams() {
                const segments = (divisionsData.length || 0) + 1;
                const scaleWidth = scaleBar.offsetWidth; 
                const segmentWidth = scaleWidth / segments;
                const divisionNominalWidth = 120;
                const isOverlapping = segmentWidth < divisionNominalWidth && divisionsData.length > 1;
                const maxLevels = isOverlapping ? Math.max(1, Math.ceil(divisionNominalWidth / segmentWidth)) : 1;
                return { isOverlapping, maxLevels };
            }


            function renderDivisions() {
                scaleBar.innerHTML = '';
                
                const layoutParams = getLayoutParams(); 
                let maxLevelUp = -1;
                let maxLevelDown = -1;
                const textElementHeight = 40; 
                const imageElementHeight = 110; 
                const rowHeight = 60; 
                let dynamicLevelsUp = new Array(layoutParams.maxLevels).fill(0);
                let dynamicLevelsDown = new Array(layoutParams.maxLevels).fill(0);

                divisionsData.forEach((item, index) => {
                    const container = document.createElement('div');
                    container.className = 'division-container';
                    container.dataset.id = item.id;
                    if (item.image) {
                        container.classList.add('has-image');
                    }

                    const { stemHeight, positionClass, level } = getDivisionStyles(index, layoutParams); 
                    container.classList.add(positionClass);
                    
                    const isImagePresent = !!item.image;
                    const elementContentHeight = isImagePresent ? imageElementHeight : textElementHeight;
                    
                    if (positionClass === 'position-up') {
                        if (level < dynamicLevelsUp.length) {
                           dynamicLevelsUp[level] = Math.max(dynamicLevelsUp[level], elementContentHeight);
                        }
                        maxLevelUp = Math.max(maxLevelUp, level);
                    } else if (positionClass === 'position-down') {
                         if (level < dynamicLevelsDown.length) {
                           dynamicLevelsDown[level] = Math.max(dynamicLevelsDown[level], elementContentHeight);
                         }
                        maxLevelDown = Math.max(maxLevelDown, level);
                    }


                    const imageContainer = document.createElement('div');
                    imageContainer.className = 'image-container';
                    if (item.image) {
                        const img = document.createElement('img');
                        if (item.image instanceof Blob) {
                           img.src = URL.createObjectURL(item.image); 
                           img.onload = () => URL.revokeObjectURL(img.src);
                        } else {
                            console.warn("Попытка создать URL не из Blob для ID:", item.id);
                        }
                        imageContainer.appendChild(img);
                    }
                    container.appendChild(imageContainer);

                    const input = document.createElement('input'); 
                    input.type = 'text';
                    input.value = item.text;
                    input.draggable = true;
                    input.addEventListener('change', () => { 
                        item.text = input.value;
                        captureState(); 
                        saveData();
                    });
                    container.appendChild(input);

                    const btnControls = document.createElement('div'); 
                    btnControls.className = 'division-btn-controls';
                    const addImgBtn = document.createElement('button');
                    addImgBtn.id = 'add-image-btn';
                    addImgBtn.innerHTML = '+';
                    addImgBtn.title = 'Вставить картинку из буфера обмена';
                    addImgBtn.dataset.itemId = item.id; 
                    btnControls.appendChild(addImgBtn);
                    
                    const removeImgFromDivBtn = document.createElement('button');
                    removeImgFromDivBtn.id = 'remove-image-from-div-btn';
                    removeImgFromDivBtn.innerHTML = '&#8722;'; // Minus sign
                    removeImgFromDivBtn.title = 'Удалить картинку';
                    btnControls.appendChild(removeImgFromDivBtn);
                    
                    const removeDivBtn = document.createElement('button');
                    removeDivBtn.id = 'remove-division-btn';
                    removeDivBtn.innerHTML = '&times;';
                    removeDivBtn.title = 'Удалить элемент';
                    btnControls.appendChild(removeDivBtn);
                    
                    container.appendChild(btnControls); 

                    const stem = document.createElement('div');
                    stem.className = 'division-stem';
                    stem.style.height = `${stemHeight}px`;
                    stem.style.order = "4"; 
                    container.appendChild(stem);
                    
                    const segments = divisionsData.length + 1;
                    const position = ((index + 1) / segments) * 100;
                    container.style.left = `${position}%`;
                    scaleBar.appendChild(container);
                });
                
                
                const baseStemHeight = 40;
                const basePaddingPx = 150; 
                
                let totalHeightUp = 0;
                let totalHeightDown = 0;

                if (maxLevelUp > -1 && maxLevelUp < dynamicLevelsUp.length) {
                    totalHeightUp = baseStemHeight + (maxLevelUp * rowHeight) + dynamicLevelsUp[maxLevelUp];
                }
                
                if (currentViewMode === 'center' && maxLevelDown > -1 && maxLevelDown < dynamicLevelsDown.length) {
                    totalHeightDown = baseStemHeight + (maxLevelDown * rowHeight) + dynamicLevelsDown[maxLevelDown];
                }

                let paddingTopPx = basePaddingPx + totalHeightUp;
                let paddingBottomPx = currentViewMode === 'center' ? basePaddingPx + totalHeightDown : 0;
                
                if (divisionsData.length === 0) {
                    paddingTopPx = basePaddingPx;
                    paddingBottomPx = currentViewMode === 'center' ? basePaddingPx : 0;
                }

                scalePanningContainer.style.paddingTop = `${paddingTopPx}px`;
                scalePanningContainer.style.paddingBottom = `${paddingBottomPx}px`;

                addDragAndDropHandlers();
                updateUndoRedoButtons(); 
            }
            
            async function handleImagePaste(id) {
                try {
                    const permission = await navigator.permissions.query({ name: 'clipboard-read' });
                    if (permission.state === 'denied') {
                        throw new Error('Доступ к буферу обмена запрещен.');
                    }
                    
                    const clipboardItems = await navigator.clipboard.read();
                    const imageItem = clipboardItems.find(item => item.types.some(type => type.startsWith("image/")));
                    
                    if (!imageItem) {
                        alert('Картинка не найдена в буфере обмена.');
                        return;
                    }
                    
                    const blob = await imageItem.getType(imageItem.types.find(t => t.startsWith("image/")));
                    
                    const item = divisionsData.find(d => d.id === id);
                    if (item) {
                        item.image = blob;
                        captureState(); 
                        await saveData();
                        renderDivisions();
                    }
                } catch (err) {
                    console.error('Ошибка вставки:', err);
                    alert('Не удалось вставить картинку. ' + err.message);
                }
            }
            
            async function handleRemoveDivision(id) {
                divisionsData = divisionsData.filter(item => item.id !== id);
                captureState(); 
                await saveData();
                renderDivisions();
            }
            
            function addDragAndDropHandlers() {
                document.querySelectorAll('.division-container input[type="text"]').forEach(input => {
                    input.addEventListener('dragstart', (e) => {
                        draggedElement = e.currentTarget.closest('.division-container');
                        draggedId = Number(draggedElement.dataset.id);
                        setTimeout(() => draggedElement.classList.add('dragging'), 0);
                    });
                    
                    input.addEventListener('dragend', () => {
                        if (!draggedElement) return;
                        draggedElement.classList.remove('dragging');
                        draggedElement = null;
                        draggedId = null
                        captureState(); 
                        saveData().then(renderDivisions);
                    });
                });
            }

            scaleBar.addEventListener('click', (event) => {
                const target = event.target;
                const container = target.closest('.division-container'); 
                if (!container) return; 

                const itemId = Number(container.dataset.id);
                 if (isNaN(itemId)) return; 

                const addBtn = target.closest('#add-image-btn');
                if (addBtn) {
                     handleImagePaste(itemId);
                     return; 
                }

                const removeDivBtn = target.closest('#remove-division-btn');
                if (removeDivBtn) {
                     handleRemoveDivision(itemId);
                     return; 
                }

                 const removeImgBtn = target.closest('#remove-image-from-div-btn');
                 if (removeImgBtn) {
                     const item = divisionsData.find(d => d.id === itemId);
                     if (item) {
                         item.image = null;
                         captureState(); 
                         saveData().then(renderDivisions);
                     }
                      return;
                 }
            });


            scaleBar.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (!draggedElement) return;

                const scaleRect = scaleBar.getBoundingClientRect();
                const mouseX = e.clientX - scaleRect.left;
                const segmentWidth = scaleRect.width / (divisionsData.length + 1);
                
                let targetIndex = Math.floor(mouseX / segmentWidth);
                targetIndex = Math.max(0, Math.min(divisionsData.length - 1, targetIndex));
                
                const currentIndex = divisionsData.findIndex(item => item.id === draggedId);
                
                if (targetIndex !== currentIndex) {
                    const item = divisionsData.splice(currentIndex, 1)[0];
                    divisionsData.splice(targetIndex, 0, item);
                }

                const layoutParams = getLayoutParams();
                
                divisionsData.forEach((item, index) => {
                    const el = scaleBar.querySelector(`.division-container[data-id="${item.id}"]`);
                    if (el) {
                        const newPosition = ((index + 1) / (divisionsData.length + 1)) * 100;
                        if (item.id !== draggedId) {
                            el.style.left = `${newPosition}%`;
                        }
                        
                        const { stemHeight, positionClass } = getDivisionStyles(index, layoutParams);
                        
                        el.className = 'division-container'; 
                        el.classList.add(positionClass);
                        if (item.id === draggedId) {
                            el.classList.add('dragging');
                        }
                        if (item.image) {
                            el.classList.add('has-image');
                        }
                        el.querySelector('.division-stem').style.height = `${stemHeight}px`;
                    }
                });
                
                draggedElement.style.left = `${mouseX}px`;
            });
            
            addButton.addEventListener('click', async () => {
                const newItem = {
                    id: Date.now(),
                    text: "Новый",
                    image: null,
                    order: divisionsData.length
                };
                divisionsData.push(newItem);
                captureState(); 
                await saveData();
                renderDivisions();
            });

            async function main() {
                applyTheme(localStorage.getItem('theme') || 'light');
                
                const savedTitle = localStorage.getItem('scaleTitle') || '';
                scaleTitle.innerText = savedTitle;
                adjustTitleFontSize();
                
                const savedMode = localStorage.getItem('viewMode') || 'bottom';
                applyViewMode(savedMode);

                try {
                    await initDB();
                    const data = await loadData();
                    if (data.length > 0) {
                        divisionsData = data;
                    } else {
                        divisionsData = getDefaultData();
                        await saveData();
                    }
                } catch (err) {
                    console.error("Не удалось загрузить данные:", err);
                     divisionsData = getDefaultData();
                }
                
                captureState();
                renderDivisions();
            }

            main();
			
            window.addEventListener('resize', () => {
                adjustTitleFontSize();
                setTimeout(renderDivisions, 0);
            });
        });
    </script>
</body>
</html>